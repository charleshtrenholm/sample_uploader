<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="datatables.min.css"/>
    <script type="text/javascript" src="datatables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="error_ui.css"/>
    <script type="text/javascript" src="error_ui.js"></script>
	</head>
	<body>
		<h2> Upload errors </h2>
    <p>Select cells in the samples table to filter the error list below.</p>
    <table id="errSampleTable" class="compact cell-border spreadsheet-table"></table>
    <hr/>
		<table id="errDetailTable" class="compact cell-border spreadsheet-table"></table>
    <script>
      // Jinja-injected data
      const error_data = {{ error_data|tojson|safe }};
			const sample_data = {{ sample_data_json|safe }};
    </script>
    <script>
      const {
        ErrorHandler, 
        createDatatableRows, 
        createDatatableColumns, 
        addExcelHeader, 
        selectionSetup,
        indexToLetters } = window.errorUI;

      $(document).ready(()=>{
        const data = createDatatableRows(sample_data.data, sample_data.index);
        const columns = createDatatableColumns(sample_data.columns);
        const errHandler = new ErrorHandler(error_data);
        const sampleTable = $('#errSampleTable').DataTable({
          dom: 'Bfrtip',
          columns:columns,
          columnDefs:[{
            targets:[0],
            className:'position-cell'
          }],
          select:{
            style:'os',
            items: 'cell',
            info:false
          },
          rowCallback: errHandler.highlightCells,
          data: data,
          buttons: [
            {
              extend: 'excelHtml5',
              title: null,
              filename: 'validated',
              exportOptions: {
                columns: columns.map((_,i)=>i).slice(1),
                modifier: {
                  search: 'none',
                  order: 'original'
                }
              },
              customize: errHandler.styleXLSX
            } 
          ]
        });

        // Hide blank sample rows
        sampleTable.columns(0).search("^.+$", true, false).draw();

        const detailTable = $('#errDetailTable').DataTable({
          dom: 'rtip',
          columns:[
            {
              data:(err)=>{
                const r = Number.isInteger(err.row) ? err.row+1 : "";
                const c = Number.isInteger(err.column) ? indexToLetters(err.column) : "";
                return `${c}${r}`
              }, 
              title:"Position"
            },
            {
              data:(err)=> err.severity=="error"?"\u00A0\ud83d\udd34\u00A0\u00A0Error":"\u00A0\ud83d\udd36\u00A0\u00A0Warning",
              title:"Severity", 
              defaultContent:""
            },
            {data:"message", title:"Error Message", defaultContent:""},
            {data:"sample_name", title:"Sample Name", defaultContent:""},
            {data:"key", title:"Column/Key", defaultContent:""},
          ],
          columnDefs:[{
            targets:[0],
            className:'position-cell'
          }],
          data: error_data
        });

        addExcelHeader(sampleTable, columns);
        selectionSetup(sampleTable, detailTable);
      });
    </script>
	</body>
</html>